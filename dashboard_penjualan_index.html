<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Penjualan</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF & html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{background:#f7f9fc}
    .card{border-radius:12px}
    .small-muted{font-size:0.85rem;color:#6c757d}
    .cursor-pointer{cursor:pointer}
    .chart-container{height:320px}
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Dashboard Penjualan Departemen Pemasaran </h2>
      <div class="d-flex gap-2">
        <button class="btn btn-primary" id="exportExcelBtn">Export Rekap ke Excel</button>
        <button class="btn btn-outline-secondary" id="exportPdfBtn">Export Rekap ke PDF</button>
        <button class="btn btn-outline-info" id="seedDataBtn">Seed Demo</button>
      </div>
    </div>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button" role="tab">Input Penjualan</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="rekap-tab" data-bs-toggle="tab" data-bs-target="#rekap" type="button" role="tab">Rekap Bulanan</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="invoice-tab" data-bs-toggle="tab" data-bs-target="#invoice" type="button" role="tab">Invoice</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Input Penjualan -->
      <div class="tab-pane fade show active" id="input" role="tabpanel">
        <div class="card p-3 mb-3">
          <form id="salesForm">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Produk</label>
                <div class="input-group">
                  <select class="form-select" id="productSelect"></select>
                  <button class="btn btn-outline-secondary" type="button" id="addProductBtn">Tambah Produk</button>
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Tonase (Kg)</label>
                <input type="number" min="1" class="form-control" id="quantity" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Harga beli (Rp)</label>
                <input type="number" min="0" class="form-control" id="price" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Harga Jual (Rp)</label>
                <input type="number" min="0" class="form-control" id="price" required>
                </div>
              <div class="col-md-3">
                <label class="form-label">Tanggal Kirim</label>
                <input type="date" class="form-control" id="saleDate" required>
              </div>
              <div></div> 
                <label class="form-label">Tanggal diterima Invoice</label>
                <input type="date" class="form-control" id="saleDate" required>
            </div>
            <div class="mt-3 text-end">
              <button class="btn btn-success" type="submit">Simpan & Buat Invoice</button>
            </div>
          </form>
        </div>

        <div class="card p-3">
          <h5>Riwayat Penjualan Terbaru</h5>
          <div class="table-responsive">
            <table class="table table-striped" id="salesTable">
              <thead><tr><th>Invoice</th><th>Tanggal</th><th>Produk</th><th>Tonase/ Kg </th><th>HJ Included</th><th>Total</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Rekap Bulanan -->
      <div class="tab-pane fade" id="rekap" role="tabpanel">
        <div class="card p-3 mb-3" id="rekapCard">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Rekap Bulanan</h5>
            <div class="d-flex gap-2">
              <select id="filterMonth" class="form-select"></select>
              <select id="filterYear" class="form-select"></select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="chart-container">
                <canvas id="barChart"></canvas>
              </div>
            </div>
            <div class="col-md-6">
              <div class="chart-container">
                <canvas id="lineChart"></canvas>
              </div>
            </div>
          </div>

          <hr>
          <h6>Detail Rekap Produk</h6>
          <div class="table-responsive">
            <table class="table table-hover" id="rekapTable">
              <thead><tr><th>Produk</th><th>Total Unit</th><th>Total Omzet (Rp)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Invoice -->
      <div class="tab-pane fade" id="invoice" role="tabpanel">
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Daftar Invoice</h5>
            <div class="input-group w-50">
              <input type="text" id="searchInvoice" class="form-control" placeholder="Cari nomor invoice / produk">
              <button class="btn btn-outline-secondary" id="clearSearch">Clear</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered" id="invoiceTable">
              <thead><tr><th>Invoice</th><th>Tanggal</th><th>Produk</th><th>Jumlah</th><th>Total</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal tambah produk -->
    <div class="modal fade" id="productModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Produk Baru</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Nama Produk</label>
            <input type="text" id="newProductName" class="form-control">
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-primary" id="saveProductBtn">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden area for invoice printable -->
    <div id="printArea" style="display:none"></div>

  </div>

  <!-- IMPORTANT: load Bootstrap JS BEFORE our custom script so `bootstrap` is defined when used -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Wrap main logic in an init function and ensure it runs whether DOMContentLoaded fired or not
  function initDashboard(){
    /*
      Dashboard Penjualan - JavaScript
      - Menyimpan data di localStorage (products, sales)
      - Membuat invoice otomatis (INV-YYYYMM-XXXX)
      - Mengupdate rekap dan chart
      - Export ke Excel & PDF
      - Search & filter
    */

    // ======= Inisialisasi data awal =======
    const initialProducts = [
      'Ammonia 99,96%',
      'Ammonia 25%',
      'Demin Water',
      'Pupuk Nitrea @1 Kg',
      'Pupuk Nitrea @5 Kg',
      'Pupuk Nitrea @25 Kg',
      'Pupuk Nitrea @50 Kg'
    ];

    function getStorage(key, fallback){
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    }
    function setStorage(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }

    let products = getStorage('products', initialProducts.slice());
    let sales = getStorage('sales', []); // setiap item {invoice, date, product, qty, price, total}

    // ======= Helper =======
    function formatCurrency(n){
      return new Intl.NumberFormat('id-ID').format(n);
    }

    function nextInvoiceNumber(date){
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth()+1).padStart(2,'0');
      // hitung urut berdasarkan sales di bulan tersebut
      const prefix = `INV-${year}${month}-`;
      const exist = sales.filter(s => s.invoice && s.invoice.startsWith(prefix)).length;
      const seq = String(exist+1).padStart(4,'0');
      return prefix + seq;
    }

    // ======= Render UI references =======
    const productSelect = document.getElementById('productSelect');
    const salesTableBody = document.querySelector('#salesTable tbody');
    const rekapTableBody = document.querySelector('#rekapTable tbody');
    const invoiceTableBody = document.querySelector('#invoiceTable tbody');
    const filterMonth = document.getElementById('filterMonth');
    const filterYear = document.getElementById('filterYear');

    function populateProductSelect(){
      productSelect.innerHTML = '';
      products.forEach(p => {
        const opt = document.createElement('option'); opt.value = p; opt.textContent = p; productSelect.appendChild(opt);
      });
    }

    function renderSalesTable(){
      salesTableBody.innerHTML = '';
      // tampilkan 50 penjualan terbaru
      const last = sales.slice().reverse().slice(0,50);
      last.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.invoice}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>Rp ${formatCurrency(s.price)}</td><td>Rp ${formatCurrency(s.total)}</td>`;
        salesTableBody.appendChild(tr);
      });
    }

    function renderInvoiceTable(filter=''){
      invoiceTableBody.innerHTML = '';
      const list = sales.slice().reverse();
      list.forEach(s => {
        if(filter){
          const f = filter.toLowerCase();
          if(!s.invoice.toLowerCase().includes(f) && !s.product.toLowerCase().includes(f)) return;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.invoice}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>Rp ${formatCurrency(s.total)}</td><td><button class="btn btn-sm btn-outline-primary" data-invoice="${s.invoice}">Cetak</button></td>`;
        invoiceTableBody.appendChild(tr);
      });

      // attach click listeners for print buttons
      invoiceTableBody.querySelectorAll('button[data-invoice]').forEach(btn => {
        btn.addEventListener('click', function(){ printInvoice(this.getAttribute('data-invoice')); });
      });
    }

    // ======= Rekap & Chart =======
    let barChart, lineChart;

    function generateMonthsYears(){
      // Pastikan tahun terisi minimal tahun sekarang
      const yearsSet = new Set();
      sales.forEach(s => { if(s.date){ const y = new Date(s.date).getFullYear(); if(!isNaN(y)) yearsSet.add(y); } });
      const minYear = yearsSet.size ? Math.min(...yearsSet) : new Date().getFullYear();
      const nowYear = new Date().getFullYear();
      filterYear.innerHTML = '';
      for(let y = nowYear; y >= minYear; y--){
        const opt = document.createElement('option'); opt.value = y; opt.textContent = y; filterYear.appendChild(opt);
      }
      filterMonth.innerHTML = '';
      for(let m=1;m<=12;m++){ const opt = document.createElement('option'); opt.value = m; opt.textContent = m; filterMonth.appendChild(opt); }

      // set defaults to current month/year
      filterYear.value = nowYear;
      filterMonth.value = new Date().getMonth()+1;
    }

    function computeRekap(month=null, year=null){
      // kelompokkan berdasarkan produk
      const map = {};
      sales.forEach(s => {
        if(!s.date) return;
        const d = new Date(s.date);
        if(month && year){
          if(d.getMonth()+1 !== Number(month) || d.getFullYear() !== Number(year)) return;
        }
        if(!map[s.product]) map[s.product] = {qty:0, omzet:0};
        map[s.product].qty += Number(s.qty);
        map[s.product].omzet += Number(s.total);
      });
      return map;
    }

    function renderRekap(){
      const month = Number(filterMonth.value) || null;
      const year = Number(filterYear.value) || null;
      const map = computeRekap(month, year);
      rekapTableBody.innerHTML = '';
      const labels = [];
      const omzetData = [];
      Object.keys(map).forEach(k => {
        const r = map[k];
        labels.push(k);
        omzetData.push(r.omzet);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${r.qty}</td><td>Rp ${formatCurrency(r.omzet)}</td>`;
        rekapTableBody.appendChild(tr);
      });

      // update charts: simple bar and line (monthly totals)
      const months = [];
      const monthlyTotals = [];
      const yy = Number(filterYear.value) || new Date().getFullYear();
      for(let m=1;m<=12;m++){
        months.push(m);
        const total = sales.filter(s => {
          if(!s.date) return false;
          const d = new Date(s.date);
          return d.getMonth()+1===m && d.getFullYear()===yy;
        }).reduce((acc, cur) => acc + Number(cur.total), 0);
        monthlyTotals.push(total);
      }

      // bar chart: omzet per produk (labels, omzetData)
      if(barChart) barChart.destroy();
      const barCtx = document.getElementById('barChart');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: labels.length?labels:['-'],
          datasets: [{ label: 'Omzet (Rp)', data: omzetData.length?omzetData:[0] }]
        },
        options: {responsive:true, maintainAspectRatio:false}
      });

      // line chart: tren bulanan untuk tahun terpilih
      if(lineChart) lineChart.destroy();
      const lineCtx = document.getElementById('lineChart');
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { labels: months.map(m=>`Bln ${m}`), datasets:[{label:`Omzet ${yy}`, data:monthlyTotals}] },
        options: {responsive:true, maintainAspectRatio:false}
      });
    }

    // ======= Submit form =======
    document.getElementById('salesForm').addEventListener('submit', function(e){
      e.preventDefault();
      const product = productSelect.value;
      const qty = Number(document.getElementById('quantity').value);
      const price = Number(document.getElementById('price').value);
      const date = document.getElementById('saleDate').value;
      if(!product || !qty || !price || !date){ alert('Lengkapi semua field'); return; }
      if(qty<=0 || price<0){ alert('Jumlah dan harga harus positif'); return; }
      const total = qty * price;
      const invoice = nextInvoiceNumber(date);
      const record = {invoice, date, product, qty, price, total};
      sales.push(record);
      setStorage('sales', sales);
      renderAll();
      // pindah ke tab invoice & show created (safe check)
      try{
        const tabEl = document.querySelector('#invoice-tab');
        if(tabEl && window.bootstrap && window.bootstrap.Tab) {
          const tab = new window.bootstrap.Tab(tabEl);
          tab.show();
        }
      } catch(err){ console.warn('Bootstrap tab switch failed:', err); }
      alert('Data tersimpan. Nomor Invoice: ' + invoice);
    });

    // ======= Modal tambah produk =======
    // Use bootstrap modal safely (check exists)
    let productModal = null;
    try{
      const modalEl = document.getElementById('productModal');
      if(window.bootstrap && window.bootstrap.Modal) productModal = new window.bootstrap.Modal(modalEl);
    } catch(e){ console.warn('Bootstrap Modal init failed', e); }

    document.getElementById('addProductBtn').addEventListener('click', ()=>{
      if(productModal) productModal.show();
      else alert('Modal tidak tersedia. Pastikan Bootstrap JS sudah dimuat.');
    });

    document.getElementById('saveProductBtn').addEventListener('click', ()=>{
      const name = document.getElementById('newProductName').value.trim();
      if(!name){ alert('Masukkan nama produk'); return; }
      if(products.includes(name)) { alert('Produk sudah ada'); return; }
      products.push(name);
      setStorage('products', products);
      populateProductSelect();
      document.getElementById('newProductName').value = '';
      if(productModal) productModal.hide();
    });

    // ======= Print & PDF =======
    window.printInvoice = function(invoiceId){
      const rec = sales.find(s => s.invoice===invoiceId);
      if(!rec) return alert('Invoice tidak ditemukan');
      const html = `<div style="font-family:Arial;padding:20px;width:600px">
        <h3>INVOICE</h3>
        <p>Nomor: <strong>${rec.invoice}</strong></p>
        <p>Tanggal: ${rec.date}</p>
        <table style="width:100%;border-collapse:collapse">
          <tr><td>Produk</td><td>${rec.product}</td></tr>
          <tr><td>Jumlah</td><td>${rec.qty}</td></tr>
          <tr><td>Harga/unit</td><td>Rp ${formatCurrency(rec.price)}</td></tr>
          <tr><td>Total</td><td>Rp ${formatCurrency(rec.total)}</td></tr>
        </table>
      </div>`;
      const w = window.open('','_blank');
      if(!w) return alert('Pop-up diblokir. Izinkan pop-up untuk mencetak.');
      w.document.write(html);
      w.document.close();
      w.print();
    }

    document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
      // export rekapan sales ke Excel
      const wb = XLSX.utils.book_new();
      const ws_data = [['Invoice','Tanggal','Produk','Jumlah','Harga','Total']];
      sales.forEach(s=> ws_data.push([s.invoice, s.date, s.product, s.qty, s.price, s.total]));
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, 'Sales');
      XLSX.writeFile(wb, 'rekap_penjualan.xlsx');
    });

    document.getElementById('exportPdfBtn').addEventListener('click', async ()=>{
      // convert rekapCard to canvas then pdf
      const el = document.getElementById('rekapCard');
      if(!el) return alert('Area rekap tidak ditemukan');
      const canvas = await html2canvas(el, {scale:2});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l','pt',[canvas.width, canvas.height]);
      pdf.addImage(imgData,'PNG',0,0,canvas.width, canvas.height);
      pdf.save('rekap_penjualan.pdf');
    });

    // ======= Seed demo data (test cases) =======
    document.getElementById('seedDataBtn').addEventListener('click', ()=>{
      if(!confirm('Ingin menambahkan data demo? Data ini akan ditambahkan ke localStorage.')) return;
      const demo = [
        {date:'2025-01-15', product: 'Ammonia 99,96%', qty:10, price:100000},
        {date:'2025-02-20', product: 'Demin Water', qty:5, price:50000},
        {date:'2025-02-28', product: 'Pupuk Nitrea @1 Kg', qty:50, price:12000},
        {date:'2025-03-05', product: 'Pupuk Nitrea @25 Kg', qty:2, price:500000},
        {date:'2025-03-25', product: 'Ammonia 25%', qty:1, price:200000},
      ];
      demo.forEach(d=>{
        const invoice = nextInvoiceNumber(d.date);
        const total = d.qty * d.price;
        sales.push({invoice, date: d.date, product: d.product, qty: d.qty, price: d.price, total});
      });
      setStorage('sales', sales);
      renderAll();
      alert('Data demo ditambahkan.');
    });

    // ======= Search invoice =======
    document.getElementById('searchInvoice').addEventListener('input', function(){
      renderInvoiceTable(this.value.trim());
    });
    document.getElementById('clearSearch').addEventListener('click', ()=>{ document.getElementById('searchInvoice').value=''; renderInvoiceTable(); });

    // ======= Init & Render all =======
    function renderAll(){
      populateProductSelect();
      renderSalesTable();
      renderInvoiceTable();
      generateMonthsYears();
      renderRekap();
    }

    // filter change triggers re-render
    filterMonth.addEventListener('change', renderRekap);
    filterYear.addEventListener('change', renderRekap);

    // inisialisasi tanggal default: hari ini
    const saleDateEl = document.getElementById('saleDate');
    if(saleDateEl) saleDateEl.value = new Date().toISOString().slice(0,10);

    renderAll();

    // Save initial products if not set
    setStorage('products', products);
  }

  // Safe-run: pastikan bootstrap tersedia. Jika belum, muat secara dinamis lalu jalankan init.
  function runInit(){
    function start(){ initDashboard(); }
    if (typeof window.bootstrap === 'undefined') {
      // bootstrap belum ada — muat secara dinamis
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
      s.onload = start;
      s.onerror = function(){ console.warn('Gagal memuat Bootstrap, melanjutkan tanpa fitur JS Bootstrap.'); start(); };
      document.body.appendChild(s);
    } else {
      start();
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runInit);
  } else {
    runInit();
  }
  </script>

</body>
</html>
